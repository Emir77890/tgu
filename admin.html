<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
  <h3>–ò–≥—Ä–æ–∫–∏:</h3>
  <ul id="users"></ul>

  <h3>–ß–∞—Ç:</h3>
  <div id="chat"></div>
  <input type="text" id="msg" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å...">
  <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <script>
    const socket = io();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    fetch("/users")
      .then(res => res.json())
      .then(data => {
        const ul = document.getElementById("users");
        data.forEach(u => {
          const li = document.createElement("li");
          li.textContent = u.username;
          ul.appendChild(li);
        });
      });

    socket.on("newMessage", (data) => {
      const div = document.createElement("div");
      div.textContent = data.username + ": " + data.text;
      document.getElementById("chat").appendChild(div);
    });

    function sendMessage() {
      const msg = document.getElementById("msg").value;
      socket.emit("sendMessage", { username: "–ê–¥–º–∏–Ω", text: msg });
      document.getElementById("msg").value = "";
    }
  </script>
  <script>
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤
  let users = JSON.parse(localStorage.getItem("users")) || [];
  let userList = document.getElementById("userList");

  function renderUsers() {
    userList.innerHTML = "";
    const now = Date.now();

    users.forEach(u => {
      let li = document.createElement("li");

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
      let status = (now - (u.lastActive || 0) < 60000) ? "üü¢ –û–Ω–ª–∞–π–Ω" : "‚ö™ –ë—ã–ª(–∞): " + new Date(u.lastActive || 0).toLocaleString();

      li.textContent = ${u.username} ‚Äî ${status};
      userList.appendChild(li);
    });
  }

  renderUsers();
</script>
  <style>
    body { font-family: Arial, sans-serif; background: #eef2f3; margin: 20px; }
    h2 { text-align: center; }
    #messages { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; margin-bottom: 10px; background: #fff; border-radius: 10px; }
    .msg { margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee; }
    .admin { color: blue; font-weight: bold; }
    .player { color: green; }
    input, button { padding: 10px; }
    button { background: #333; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>–ß–∞—Ç —Å –∏–≥—Ä–æ–∫–∞–º–∏</h2>
  <div id="messages"></div>
  <div>
    <input type="text" id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞...">
    <button onclick="sendAdminMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

  <script>
    let messages = JSON.parse(localStorage.getItem("messages")) || [];
    let msgBox = document.getElementById("messages");
    let adminName = "–ê–¥–º–∏–Ω";

    function renderMessages() {
      msgBox.innerHTML = "";
      messages.forEach(m => {
        let div = document.createElement("div");
        div.className = "msg " + (m.username === adminName ? "admin" : "player");
        div.textContent = m.username + ": " + m.text;
        msgBox.appendChild(div);
      });
      msgBox.scrollTop = msgBox.scrollHeight; // –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    }
    renderMessages();

    function sendAdminMessage() {
      let input = document.getElementById("msgInput");
      if (!input.value) return;

      let msg = { username: adminName, text: input.value, time: Date.now() };
      messages.push(msg);
      localStorage.setItem("messages", JSON.stringify(messages));

      input.value = "";
      renderMessages();
    }

    // –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
    setInterval(() => {
      messages = JSON.parse(localStorage.getItem("messages")) || [];
      renderMessages();
    }, 2000);
  </script>
</body>
</html>